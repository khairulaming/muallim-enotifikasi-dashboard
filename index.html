<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Muallim eNotifikasi Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 1.3rem;
      margin-top: 32px;
      margin-bottom: 8px;
    }

    p.subtitle {
      margin-top: 0;
      color: #555;
      font-size: 0.9rem;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-top: 12px;
    }

    .upload-row {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    input[type="file"] {
      padding: 4px;
    }

    .filters-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    label {
      font-size: 0.9rem;
      color: #444;
      margin-right: 4px;
    }

    select {
      min-width: 180px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d0d0d0;
      background: #fff;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .kpi-box {
      background: #fafafa;
      border-radius: 8px;
      padding: 12px 14px;
      border: 1px solid #eee;
    }

    .kpi-title {
      font-size: 0.85rem;
      color: #777;
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .note {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #777;
    }

    canvas {
      max-height: 420px;
    }

    .muted {
      color: #888;
      font-size: 0.85rem;
    }

    /* Demography layout */
    .demography-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    .demo-block-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .demo-card {
      text-align: center;
    }

    /* Diagnosis table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: #fafafa;
    }

    th {
      font-weight: 600;
      color: #374151;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Muallim District eNotifikasi Dashboard</h1>
  <p class="subtitle">by Dr Ahmad Akmal Bin Ahmad Nizam, DrPH UiTM, 2025</p>

  <!-- Section 1: Upload -->
  <h2>1. Upload Enotis Excel file</h2>
  <div class="card">
    <div class="upload-row">
      <div>
        <label for="fileInput"><strong>Excel file (.xls / .xlsx):</strong></label>
        <input type="file" id="fileInput" accept=".xls,.xlsx" />
      </div>
      <div class="muted" id="fileInfo">No file loaded yet.</div>
    </div>
  </div>

  <!-- Section 2: Filters and key numbers -->
  <h2>2. Filters and key numbers</h2>
  <div class="card">
    <div class="filters-row">
      <div>
        <label for="filterDiagnosis">Diagnosis:</label>
        <select id="filterDiagnosis" disabled>
          <option value="ALL">All diagnosis</option>
        </select>
      </div>

      <div>
        <label for="filterStatus">Notifikasi Status:</label>
        <select id="filterStatus" disabled>
          <option value="ALL">All status</option>
        </select>
      </div>

      <div>
        <label for="filterWeek">Epid Week:</label>
        <select id="filterWeek" disabled>
          <option value="ALL">All weeks</option>
        </select>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-box">
        <div class="kpi-title">Total notifications</div>
        <div class="kpi-value" id="kpiTotal">0</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">Number of diagnosis</div>
        <div class="kpi-value" id="kpiDiseases">0</div>
      </div>
    </div>

    <div class="note">
      All numbers change based on the chosen diagnosis, Notifikasi Status, and Epid Week.
    </div>
  </div>

  <!-- Section 3: Diagnosis breakdown -->
  <h2>3. Diagnosis breakdown</h2>
  <div class="card">
    <p class="muted">
      Counts of each diagnosis after applying the filters above.
    </p>
    <table>
      <thead>
        <tr>
          <th style="width:70%;">Diagnosis</th>
          <th>Notifications</th>
        </tr>
      </thead>
      <tbody id="diagnosisTableBody">
        <tr>
          <td>No data</td>
          <td>0</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Section 4: Weekly trend -->
  <h2>4. Weekly trend</h2>
  <div class="card">
    <p class="muted">
      Notifications by epidemiological week of input date, filtered by diagnosis, Notifikasi Status, and Epid Week.
    </p>
    <canvas id="weeklyChart"></canvas>
  </div>

  <!-- Section 5: Demography -->
  <h2>5. Demography</h2>
  <div class="card">
    <p class="muted">
      Distribution of cases by gender, age, nationality, and ethnicity after applying the filters above.
    </p>
    <div class="demography-grid">
      <div class="demo-card">
        <div class="demo-block-title">Jantina</div>
        <canvas id="genderChart"></canvas>
      </div>
      <div class="demo-card">
        <div class="demo-block-title">Umur</div>
        <canvas id="ageChart"></canvas>
      </div>
      <div class="demo-card">
        <div class="demo-block-title">Status Kewarganegaraan</div>
        <canvas id="citizenChart"></canvas>
      </div>
      <div class="demo-card">
        <div class="demo-block-title">Bangsa</div>
        <canvas id="ethnicityChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  // We will try to detect columns safely by matching header names loosely.
  const columnMap = {
    diagnosis: null,
    status: null,
    week: null,
    date: null,
    gender: null,
    age: null,
    citizen: null,
    ethnicity: null
  };

  let rawData = [];
  let weeklyChart = null;
  let genderChart = null;
  let ageChart = null;
  let citizenChart = null;
  let ethnicityChart = null;

  const fileInput = document.getElementById('fileInput');
  const fileInfo = document.getElementById('fileInfo');

  const diagnosisSelect = document.getElementById('filterDiagnosis');
  const statusSelect = document.getElementById('filterStatus');
  const weekSelect = document.getElementById('filterWeek');

  const kpiTotal = document.getElementById('kpiTotal');
  const kpiDiseases = document.getElementById('kpiDiseases');

  const diagnosisTableBody = document.getElementById('diagnosisTableBody');

  fileInput.addEventListener('change', handleFileSelect);
  diagnosisSelect.addEventListener('change', updateDashboard);
  statusSelect.addEventListener('change', updateDashboard);
  weekSelect.addEventListener('change', updateDashboard);

  function handleFileSelect(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    fileInfo.textContent = `Loading ${file.name} ...`;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });

      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];

      rawData = XLSX.utils.sheet_to_json(worksheet, { defval: null });

      fileInfo.textContent = `Loaded ${file.name} with ${rawData.length} rows.`;

      if (!rawData || rawData.length === 0) {
        alert("No rows found in the first sheet.");
        return;
      }

      inferColumns();
      buildFilterOptions();
      updateDashboard();
    };
    reader.readAsArrayBuffer(file);
  }

  // Tries to find a matching header among keys, using several candidate names.
  function findColumnKey(keys, candidates) {
    const norm = s => s.toString().toLowerCase().replace(/\s+/g, ' ').trim();

    const normKeys = keys.map(k => ({ key: k, normKey: norm(k) }));
    const normCandidates = candidates.map(c => norm(c));

    // Exact (normalized) match
    for (const { key, normKey } of normKeys) {
      if (normCandidates.includes(normKey)) return key;
    }

    // Starts-with match (e.g. "Jantina" vs "Jantina Pesakit")
    for (const { key, normKey } of normKeys) {
      for (const c of normCandidates) {
        if (normKey.startsWith(c)) return key;
      }
    }

    return null;
  }

  function inferColumns() {
    const firstRow = rawData[0];
    const keys = Object.keys(firstRow || {});

    columnMap.diagnosis = findColumnKey(keys, ['Diagnosis', 'DX']);
    columnMap.status = findColumnKey(keys, ['Notifikasi Status', 'Status Notifikasi', 'BR']);
    columnMap.week   = findColumnKey(keys, ['Epid Minggu (Tkh Input Notifikasi)', 'Epid Minggu', 'Epid Week']);
    columnMap.date   = findColumnKey(keys, ['Tarikh Input Notifikasi', 'Tarikh Notifikasi']);

    columnMap.gender   = findColumnKey(keys, ['Jantina', 'Sex', 'Gender', 'Jantina Pesakit']);
    columnMap.age      = findColumnKey(keys, ['Umur', 'Age', 'Umur Pesakit']);
    columnMap.citizen  = findColumnKey(keys, ['Status Kewarganegaraan', 'Kewarganegaraan', 'Citizenship']);
    columnMap.ethnicity= findColumnKey(keys, ['Bangsa', 'Keturunan', 'Etnik', 'Ethnicity']);

    console.log('Detected columns:', columnMap);
  }

  function buildFilterOptions() {
    const diagSet = new Set();
    const statusSet = new Set();
    const weekSet = new Set();

    rawData.forEach(row => {
      const dxKey = columnMap.diagnosis;
      const stKey = columnMap.status;
      const wkKey = columnMap.week;

      const dx = dxKey ? row[dxKey] : null;
      const st = stKey ? row[stKey] : null;
      const wk = wkKey ? row[wkKey] : null;

      if (dx != null && String(dx).trim() !== '') diagSet.add(String(dx).trim());
      if (st != null && String(st).trim() !== '') statusSet.add(String(st).trim());
      if (wk != null && String(wk).trim() !== '') {
        const num = parseInt(wk, 10);
        if (!isNaN(num)) weekSet.add(num);
      }
    });

    // Diagnosis dropdown
    diagnosisSelect.innerHTML = '';
    const optAllDx = document.createElement('option');
    optAllDx.value = 'ALL';
    optAllDx.textContent = 'All diagnosis';
    diagnosisSelect.appendChild(optAllDx);

    Array.from(diagSet).sort().forEach(dx => {
      const opt = document.createElement('option');
      opt.value = dx;
      opt.textContent = dx;
      diagnosisSelect.appendChild(opt);
    });

    // Status dropdown
    statusSelect.innerHTML = '';
    const optAllSt = document.createElement('option');
    optAllSt.value = 'ALL';
    optAllSt.textContent = 'All status';
    statusSelect.appendChild(optAllSt);

    Array.from(statusSet).sort().forEach(st => {
      const opt = document.createElement('option');
      opt.value = st;
      opt.textContent = st;
      statusSelect.appendChild(opt);
    });

    // Week dropdown
    weekSelect.innerHTML = '';
    const optAllWk = document.createElement('option');
    optAllWk.value = 'ALL';
    optAllWk.textContent = 'All weeks';
    weekSelect.appendChild(optAllWk);

    Array.from(weekSet).sort((a, b) => a - b).forEach(wk => {
      const opt = document.createElement('option');
      opt.value = wk;
      opt.textContent = `Week ${wk}`;
      weekSelect.appendChild(opt);
    });

    diagnosisSelect.disabled = false;
    statusSelect.disabled = false;
    weekSelect.disabled = false;
  }

  function getFilteredData() {
    const dxFilter = diagnosisSelect.value || 'ALL';
    const stFilter = statusSelect.value || 'ALL';
    const wkFilter = weekSelect.value || 'ALL';

    return rawData.filter(row => {
      const dxKey = columnMap.diagnosis;
      const stKey = columnMap.status;
      const wkKey = columnMap.week;

      const dx = dxKey ? row[dxKey] : null;
      const st = stKey ? row[stKey] : null;
      const wk = wkKey ? row[wkKey] : null;

      const matchDx = (dxFilter === 'ALL') || (dx != null && String(dx).trim() === dxFilter);
      const matchSt = (stFilter === 'ALL') || (st != null && String(st).trim() === stFilter);

      let matchWk = true;
      if (wkFilter !== 'ALL') {
        const wkNum = parseInt(wk, 10);
        matchWk = !isNaN(wkNum) && wkNum === parseInt(wkFilter, 10);
      }

      return matchDx && matchSt && matchWk;
    });
  }

  function updateDashboard() {
    if (!rawData || rawData.length === 0) return;

    const filtered = getFilteredData();
    updateKpis(filtered);
    updateDiagnosisTable(filtered);
    updateWeeklyChart(filtered);
    updateDemographyCharts(filtered);
  }

  function updateKpis(data) {
    kpiTotal.textContent = data.length;

    const diseaseSet = new Set();
    const dxKey = columnMap.diagnosis;

    data.forEach(row => {
      const dx = dxKey ? row[dxKey] : null;
      if (dx != null && String(dx).trim() !== '') {
        diseaseSet.add(String(dx).trim());
      }
    });

    kpiDiseases.textContent = diseaseSet.size;
  }

  // New: update diagnosis breakdown table
  function updateDiagnosisTable(data) {
    // Clear table body
    diagnosisTableBody.innerHTML = '';

    const dxKey = columnMap.diagnosis;
    if (!dxKey) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>No diagnosis column found</td><td>0</td>';
      diagnosisTableBody.appendChild(tr);
      return;
    }

    const countsMap = new Map();

    data.forEach(row => {
      let dx = row[dxKey];
      if (dx == null) return;
      dx = String(dx).trim();
      if (!dx) return;
      countsMap.set(dx, (countsMap.get(dx) || 0) + 1);
    });

    const entries = Array.from(countsMap.entries())
      .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));

    if (!entries.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>No data</td><td>0</td>';
      diagnosisTableBody.appendChild(tr);
      return;
    }

    entries.forEach(([dx, count]) => {
      const tr = document.createElement('tr');
      const tdDx = document.createElement('td');
      const tdCt = document.createElement('td');
      tdDx.textContent = dx;
      tdCt.textContent = count;
      tr.appendChild(tdDx);
      tr.appendChild(tdCt);
      diagnosisTableBody.appendChild(tr);
    });
  }

  function updateWeeklyChart(data) {
    const wkKey = columnMap.week;
    if (!wkKey || !rawData || rawData.length === 0) return;

    // 1. Find the highest epidemiological week in the full dataset
    let maxWeek = 0;
    rawData.forEach(row => {
      let wk = row[wkKey];
      if (wk == null || wk === '') return;
      wk = parseInt(wk, 10);
      if (isNaN(wk)) return;
      if (wk > maxWeek) maxWeek = wk;
    });

    if (!maxWeek || maxWeek < 1) {
      if (weeklyChart) {
        weeklyChart.destroy();
        weeklyChart = null;
      }
      return;
    }

    // 2. Count notifications per week for the filtered data
    const weekCounts = {};
    data.forEach(row => {
      let wk = row[wkKey];
      if (wk == null || wk === '') return;
      wk = parseInt(wk, 10);
      if (isNaN(wk)) return;
      if (!weekCounts[wk]) weekCounts[wk] = 0;
      weekCounts[wk] += 1;
    });

    // 3. Build continuous series from week 1 to the most recent week
    const weeks = [];
    const counts = [];
    for (let w = 1; w <= maxWeek; w++) {
      weeks.push(w);
      counts.push(weekCounts[w] || 0);
    }

    const ctx = document.getElementById('weeklyChart').getContext('2d');

    if (weeklyChart) {
      weeklyChart.destroy();
    }

    weeklyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: weeks,
        datasets: [{
          label: 'Notifications per week',
          data: counts,
          tension: 0.2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Epid week (Tkh Input Notifikasi)'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Count'
            },
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            display: true
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Week ${context.label}: ${context.raw} notifications`;
              }
            }
          }
        }
      }
    });
  }

  // Utility to create category counts for a column
  function buildCategoryCounts(data, colKey) {
    const map = new Map();
    if (!colKey) return map;

    data.forEach(row => {
      let val = row[colKey];
      if (val == null) return;
      val = String(val).trim();
      if (val === '') return;
      const current = map.get(val) || 0;
      map.set(val, current + 1);
    });

    return map;
  }

  function createOrUpdatePie(chartRef, canvasId, labels, counts) {
    const ctx = document.getElementById(canvasId).getContext('2d');

    const palette = ['#ef4444','#06b6d4','#22c55e','#f59e0b','#6366f1','#a855f7','#14b8a6','#f97316','#f97373','#4ade80'];

    const bgColors = labels.map((_, i) => palette[i % palette.length]);

    if (chartRef && chartRef.destroy) {
      chartRef.destroy();
    }

    return new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: counts,
          backgroundColor: bgColors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  function updateDemographyCharts(data) {
    // Gender
    const genderCounts = buildCategoryCounts(data, columnMap.gender);
    const genderLabels = Array.from(genderCounts.keys());
    const genderValues = Array.from(genderCounts.values());

    genderChart = createOrUpdatePie(
      genderChart,
      'genderChart',
      genderLabels.length ? genderLabels : ['No data'],
      genderLabels.length ? genderValues : [1]
    );

    // Age (keep raw ages)
    const ageCounts = buildCategoryCounts(data, columnMap.age);
    const ageLabels = Array.from(ageCounts.keys());
    const ageValues = Array.from(ageCounts.values());

    ageChart = createOrUpdatePie(
      ageChart,
      'ageChart',
      ageLabels.length ? ageLabels : ['No data'],
      ageLabels.length ? ageValues : [1]
    );

    // Citizenship
    const citizenCounts = buildCategoryCounts(data, columnMap.citizen);
    const citizenLabels = Array.from(citizenCounts.keys());
    const citizenValues = Array.from(citizenCounts.values());

    citizenChart = createOrUpdatePie(
      citizenChart,
      'citizenChart',
      citizenLabels.length ? citizenLabels : ['No data'],
      citizenLabels.length ? citizenValues : [1]
    );

    // Ethnicity
    const ethCounts = buildCategoryCounts(data, columnMap.ethnicity);
    const ethLabels = Array.from(ethCounts.keys());
    const ethValues = Array.from(ethCounts.values());

    ethnicityChart = createOrUpdatePie(
      ethnicityChart,
      'ethnicityChart',
      ethLabels.length ? ethLabels : ['No data'],
      ethLabels.length ? ethValues : [1]
    );
  }
</script>
</body>
</html>
